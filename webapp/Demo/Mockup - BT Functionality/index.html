<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://github.com/Aetriq/CEG491X-Capstone/blob/main/webapp/loadinglogo.png?raw=true">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoLog Web APP</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { 
            --sidebar-bg: #1a7199; 
            --sidebar-hover: #155d7e; 
            /* REVAMP: Slightly darker, blue-tinged background for contrast with glass cards */
            --main-bg: #e0e8ef; 
            --card-bg: rgba(255, 255, 255, 0.65); 
            --glass-border: 1px solid rgba(255, 255, 255, 0.4);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --btn-green: #4CAF50; 
            --btn-orange: #FF9800; 
            --btn-red: #F44336; 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { height: 100vh; background-color: var(--main-bg); overflow: hidden; }
        
        /* --- ANIMATIONS --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--sidebar-bg); 
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            animation: bgFadeOut 0.8s ease-in-out 0.5s forwards;
            pointer-events: none;
        }

        /* Find this existing block in your CSS and replace it */
        .splash-logo {
            width: 25vmin; /* Sets size relative to screen viewport */
            /* Ensures the logo maintains aspect ratio and doesn't stretch */
            height: auto; 
            object-fit: contain;

            /* --- NEW EFFECTS --- */
            /* We use two drop-shadow filters stacked together.
            1. The Outer Glow: centered (0 0), large blur (20px), bright white color.
            2. The Drop Shadow: slightly offset (4px 4px), smaller blur (8px), dark semi-transparent color.
            */
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.8)) 
                    drop-shadow(4px 4px 8px rgba(0, 0, 0, 0.5));

            /* Keep the original animation logic */
            animation: logoScaleFade 0.8s ease-in 0.5s forwards; 
        }

        @keyframes bgFadeOut { 0% { opacity: 1; } 100% { opacity: 0; visibility: hidden; } }
        @keyframes logoScaleFade { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(20); opacity: 0; } }

        /* REVAMP: Floating squares now Fixed to cover full viewport height */
        .floating-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            overflow: hidden; z-index: 0; pointer-events: none;
        }

        .square {
            position: absolute; width: 40px; height: 40px;
            background: rgba(26, 113, 153, 0.05); 
            border: 1px solid rgba(26, 113, 153, 0.1);
            backdrop-filter: blur(2px);
            left: -100px;
        }

        /* Distributed vertical positions to cover full page */
        .square:nth-child(1) { top: 10%; animation: floatRight 15s linear infinite; }
        .square:nth-child(2) { top: 20%; animation: floatRight 22s linear infinite 2s; width: 60px; height: 60px; }
        .square:nth-child(3) { top: 35%; animation: floatRight 18s linear infinite 5s; }
        .square:nth-child(4) { top: 50%; animation: floatRight 25s linear infinite 1s; width: 30px; height: 30px; }
        .square:nth-child(5) { top: 65%; animation: floatRight 20s linear infinite 8s; }
        .square:nth-child(6) { top: 80%; animation: floatRight 28s linear infinite 10s; }
        .square:nth-child(7) { top: 90%; animation: floatRight 17s linear infinite 4s; width: 50px; height: 50px; }

        @keyframes floatRight {
            0% { left: -10%; transform: rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { left: 110%; transform: rotate(360deg); opacity: 0; }
        }

        @keyframes slideUpFade { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }

        /* --- LOGIN SCREEN REVAMP --- */
        #login-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 1000; display: flex; background: white; 
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55); 
        }
        .login-exit { animation: slideUpFade 0.8s forwards; }
        
        .login-left { 
            width: 40%; 
            /* Gradient background stays */
            background: linear-gradient(135deg, #1a7199 0%, #0d3d54 100%); 
            color: white; display: flex; flex-direction: column; justify-content: center; 
            padding: 60px; box-shadow: 5px 0 15px rgba(0,0,0,0.1); z-index: 2; 
            min-height: 100vh; /* FIX: Ensures no white bars */
            position: relative;
        }

        /* Subtle glass container behind the inputs for the "Liquid" feel */
        .login-glass-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .login-right { 
            width: 60%; 
            background-size: cover; 
            background-position: center; 
            position: relative; 
            min-height: 100vh; /* FIX: Ensures full height coverage */
            background-image: url('https://raw.githubusercontent.com/Aetriq/CEG491X-Capstone/refs/heads/main/webapp/boat.png'); 
        } 
        
        .login-title { font-size: 48px; font-weight: bold; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); animation: slideInLeft 0.5s ease-out; }
        .login-sub { font-size: 24px; opacity: 0.8; margin-bottom: 30px; animation: slideInLeft 0.7s ease-out; }
        .login-group { margin-bottom: 20px; animation: slideInLeft 0.9s ease-out; }
        .login-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        
        /* REVAMP: Glass inputs */
        .login-input { 
            width: 100%; padding: 15px; border-radius: 8px; border: none; font-size: 16px; outline: none; transition: 0.3s; 
            background: rgba(255, 255, 255, 0.1); /* Glassy */
            backdrop-filter: blur(10px);
            color: white; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .login-input::placeholder { color: rgba(255,255,255,0.5); }
        .login-input:focus { 
            background: rgba(255, 255, 255, 0.25); 
            box-shadow: 0 0 15px rgba(255,255,255,0.2); 
            border-color: rgba(255,255,255,0.5);
            transform: translateX(5px); 
        }
        
        .login-links { display: flex; justify-content: space-between; font-size: 12px; margin-top: 15px; animation: slideInLeft 1.1s ease-out; }
        .login-links a { color: #ccc; text-decoration: none; transition: 0.2s; }
        .login-links a:hover { color: white; text-decoration: underline; }
        
        .btn-login { 
            background: rgba(255, 255, 255, 0.1); 
            color: white; padding: 15px; width: 100%; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; 
            backdrop-filter: blur(10px); 
            animation: slideInLeft 1.3s ease-out; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .btn-login:hover { 
            background: rgba(255, 255, 255, 0.9); 
            color: #1a7199; transform: translateY(-2px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
        }
        
        .error-msg { color: #ff9999; font-size: 13px; margin-top: 10px; min-height: 20px; }
        
        /* --- APP LAYOUT --- */
        #app-container { display: none; width: 100%; height: 100%; opacity: 0; }
        .app-enter { display: flex !important; animation: zoomIn 0.8s forwards 0.3s; }
        
        /* Sidebar unchanged structure, slight z-index tweak */
        .sidebar { 
            width: 250px; background: linear-gradient(180deg, var(--sidebar-bg) 0%, #0f4c66 100%); 
            color: white; display: flex; flex-direction: column; padding: 20px; flex-shrink: 0; 
            box-shadow: 5px 0 25px rgba(0,0,0,0.15); z-index: 10;
        }
        .logo { font-size: 24px; font-weight: bold; margin-bottom: 20px; letter-spacing: 1px; }
        .status-panel { font-size: 12px; margin-bottom: 30px; opacity: 0.8; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; }
        .menu-item { padding: 12px 15px; margin-bottom: 5px; border-radius: 5px; cursor: pointer; transition: all 0.2s; font-size: 15px; position: relative; overflow: hidden; }
        .menu-item:hover { background-color: var(--sidebar-hover); transform: translateX(5px); }
        .menu-item.active { 
            background: linear-gradient(90deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%); 
            border-left: 4px solid #fff; font-weight: bold; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .user-panel { margin-top: auto; text-align: center; }
        .avatar-circle { width: 40px; height: 40px; background: white; color: var(--sidebar-bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 20px; transition: 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .avatar-circle:hover { transform: rotate(360deg) scale(1.1); }
        .logout { color: #ffcccc; font-size: 12px; margin-top: 5px; cursor: pointer; transition: 0.2s; }
        .logout:hover { color: white; text-decoration: underline; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background: var(--main-bg); position: relative; }
        .page-view { display: none; }
        .page-view.active-view { display: block; animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .welcome-hero { text-align: center; margin-top: 100px; color: #333; animation: float 6s ease-in-out infinite; position: relative; z-index: 2; }
        .welcome-hero h1 { font-size: 42px; margin-bottom: 10px; background: linear-gradient(45deg, #1a7199, #00bcd4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .welcome-hero p { color: #556677; font-size: 18px; }
        
        .top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .bottom-row { margin-bottom: 20px; }
        
        /* REVAMP: Glassmorphism Card Style */
        .card { 
            background: var(--card-bg); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px; 
            padding: 25px; 
            box-shadow: var(--glass-shadow);
            transition: all 0.3s; 
            position: relative;
            overflow: hidden;
        }
        /* Shine effect on hover */
        .card::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.5s; pointer-events: none;
        }
        .card:hover::before { left: 100%; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(31, 38, 135, 0.15); border-color: rgba(255,255,255,0.9); }
        
        .card-header { display: flex; align-items: center; margin-bottom: 15px; }
        .icon-box { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card:hover .icon-box { transform: scale(1.1) rotate(5deg); }
        .orange-icon { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .red-icon { background: linear-gradient(135deg, #b71c1c, #d32f2f); }
        .teal-icon { background: linear-gradient(135deg, #00bcd4, #0097a7); }
        
        h3 { font-size: 18px; color: #2c3e50; margin-bottom: 5px; }
        p.subtext { font-size: 13px; color: #607d8b; }
        
        .control-group { margin-top: 15px; }
        .info-line { font-size: 14px; margin-bottom: 10px; color: #455a64; font-family: monospace; white-space: pre-wrap; background: rgba(255,255,255,0.5); padding: 8px; border-radius: 6px; border-left: 3px solid #1a7199; }
        
        /* REVAMP: Glassy Buttons */
        .btn { 
            border: none; padding: 10px 20px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; margin-right: 8px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; transition: all 0.2s; position: relative; overflow: hidden; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 7px 14px rgba(0,0,0,0.15); filter: brightness(110%); }
        .btn:disabled { background: #cfd8dc !important; cursor: not-allowed; transform: none; box-shadow: none; filter: none; color: #90a4ae; border: none; }
        
        .btn-green { background: linear-gradient(135deg, var(--btn-green), #388E3C); }
        .btn-orange { background: linear-gradient(135deg, var(--btn-orange), #F57C00); }
        .btn-red { background: linear-gradient(135deg, var(--btn-red), #D32F2F); }
        .btn-blue { background: linear-gradient(135deg, #2196F3, #1976D2); }
        .btn-dark { background: linear-gradient(135deg, #455A64, #263238); }
        
        select { padding: 8px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8); margin-right: 10px; min-width: 150px; transition: 0.2s; }
        select:focus { border-color: var(--sidebar-bg); box-shadow: 0 0 5px rgba(26,113,153,0.3); outline: none; }
        
        .connection-single { display: block; margin-top: 15px; }
        .conn-box { background: rgba(255,255,255,0.5); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.6); min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: flex-start; transition: 0.3s; }
        .conn-box:hover { background: rgba(255,255,255,0.8); border-color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .conn-title { font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #1a7199; }
        .device-list { font-family: monospace; font-size: 13px; color: #555; margin-bottom: 15px; width: 100%; }
        
        .form-group { margin-bottom: 20px; opacity: 0; animation: slideInLeft 0.5s ease-out forwards; }
        .form-group:nth-child(1) { animation-delay: 0.1s; }
        .form-group:nth-child(2) { animation-delay: 0.2s; }
        .form-group:nth-child(3) { animation-delay: 0.3s; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #444; }
        .form-input { padding: 12px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.8); border-radius: 6px; width: 100%; max-width: 400px; transition: 0.3s; }
        .form-input:focus { border-color: var(--sidebar-bg); transform: scale(1.01); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .form-slider { width: 100%; max-width: 400px; cursor: pointer; }
        
        #event-log-screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 500; background: white; opacity: 0; transition: opacity 0.4s; }
        #event-log-screen.show-log { opacity: 1; }
        .elog-sidebar { width: 250px; background: linear-gradient(180deg, #1a7199 0%, #0f4c66 100%); color: white; padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #ccc; }
        .elog-panel { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
        .elog-info-row { margin-bottom: 8px; font-size: 13px; display: flex; align-items: center; }
        .elog-info-row i { width: 20px; }
        .elog-btn { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; font-weight: bold; color: white; cursor: pointer; text-align: center; font-size: 13px; background: rgba(0,0,0,0.2); transition: 0.2s; }
        .elog-btn:hover { background: rgba(255,255,255,0.2); transform: translateX(3px); }
        .elog-main { flex: 1; padding: 0; display: flex; flex-direction: column; background: #fdfdfd; }
        .elog-header { background: white; padding: 15px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .elog-content { padding: 30px; overflow-y: auto; }
        .elog-table { width: 100%; border-collapse: collapse; font-size: 14px; animation: slideInLeft 0.5s ease-out; }
        .elog-table th { text-align: left; padding: 12px; color: #555; border-bottom: 2px solid #eee; }
        .elog-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; color: #333; transition: 0.2s; }
        .elog-table tr { transition: 0.2s; }
        .elog-table tr:hover { background: #f0f8ff; transform: scale(1.005); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <div id="splash-screen">
        <img src="https://github.com/Aetriq/CEG491X-Capstone/blob/main/webapp/loadinglogo.png?raw=true" class="splash-logo" alt="Logo">
    </div>

    <div id="login-screen">
        <div class="login-left">
            <div class="login-glass-panel">
                <div class="login-title">EchoLog</div>
                <div class="login-sub">Login Now.</div>
                <div class="login-group">
                    <label class="login-label">Username</label>
                    <input type="text" id="loginUser" class="login-input" placeholder="Enter Username">
                </div>
                <div class="login-group">
                    <label class="login-label">Password</label>
                    <input type="password" id="loginPass" class="login-input" placeholder="Enter Password">
                </div>
                <div class="login-links">
                    <a href="#">Forgot Password?</a>
                    <a href="#">Register Here</a>
                </div>
                <div class="error-msg" id="loginError"></div>
                <button class="btn-login" onclick="attemptLogin()">Login</button>
            </div>
        </div>
        <div class="login-right"></div>
    </div>

    <div id="app-container">
        <div class="sidebar">
            <div class="logo">EchoLog</div>
            <div class="status-panel">Device: <span id="connStatus">Disconnected</span><br>Status: === / ===</div>
            <div class="menu-item active" onclick="navTo('home')" id="nav-home">Home</div>
            <div class="menu-item" onclick="navTo('device')" id="nav-device">EchoLog Device →</div>
            <div class="menu-item" onclick="navTo('config')" id="nav-config">Config Settings</div>
            <div class="menu-item" onclick="navTo('account')" id="nav-account">Account</div>
            <div class="menu-item" onclick="openEventLog()" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.2); padding-top:15px">Event Log</div>
            <div class="user-panel">
                <div class="avatar-circle"><i class="fas fa-user"></i></div>
                <div class="username" id="displayUsername">username</div>
                <div class="logout" onclick="location.reload()">Logout</div>
            </div>
        </div>

        <div class="main-content">
            
            <div id="view-home" class="page-view active-view" style="position:relative;">
                <div class="floating-bg">
                    <div class="square"></div><div class="square"></div>
                    <div class="square"></div><div class="square"></div>
                    <div class="square"></div><div class="square"></div>
                    <div class="square"></div>
                </div>

                <div class="welcome-hero">
                    <h1 id="welcomeText">Welcome User</h1>
                    <p>Select an option from the sidebar to begin.</p>
                </div>
            </div>

            <div id="view-device" class="page-view">
                <div class="top-row">
                    <div class="card">
                        <div class="card-header"><div class="icon-box orange-icon"><i class="fas fa-arrow-up"></i></div><div><h3>Upload Files</h3><p class="subtext">Upload files to onboard storage</p></div></div>
                        <div class="info-line" id="uploadStatus">File: -<br>Size: 0Kb</div>
                        <div class="control-group">
                            <input type="file" id="fileInput" style="display: none;">
                            <button class="btn btn-green" id="btnStartUpload" disabled>START ▶</button>
                            <button class="btn btn-orange" onclick="document.getElementById('fileInput').click()">SELECT FILES</button>
                            <button class="btn btn-red" id="btnStopUpload">STOP</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><div class="icon-box red-icon"><i class="fas fa-arrow-down"></i></div><div><h3>Download Files</h3><p class="subtext">Download device's raw files</p></div></div>
                        <div class="info-line" id="dlStatus">Status: Idle</div>
                        <div class="control-group">
                            <select id="fileSelect"><option>Refresh to list...</option></select>
                            <button class="btn btn-blue" id="btnRefresh" disabled><i class="fas fa-sync"></i></button>
                            <button class="btn btn-green" id="btnDownload" disabled>DOWNLOAD</button>
                        </div>
                    </div>
                </div>
                <div class="card bottom-row">
                    
                    <div class="card-header"><div class="icon-box teal-icon"><i class="fas fa-link"></i></div><div><h3>Connect Device</h3><p class="subtext">Connect via Bluetooth Low Energy (BLE)</p></div></div>
                    <div class="connection-single"><div class="conn-box"><div class="conn-title">Bluetooth Connection:</div><div class="device-list" id="bleList">Status: Not Connected</div><div><button class="btn btn-orange" id="btnScan">SCAN & CONNECT</button><button class="btn btn-red" id="btnDisconnect" style="display:none">DISCONNECT</button></div></div></div>
                </div>
            </div>

            <div id="view-config" class="page-view">
                <div class="card">
                    <h3>Configuration Settings</h3>
                    <p class="subtext" style="margin-bottom:20px">Manage device parameters</p>
                    <div class="form-group">
                        <label class="form-label">Device Name</label>
                        <input type="text" class="form-input" value="EchoLog-01">
                        <button class="btn btn-blue" style="margin-left:10px">Rename</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Audio Recording Length (s)</label>
                        <input type="range" min="0" max="120" value="60" class="form-slider" oninput="document.getElementById('sVal').innerText = this.value + 's'">
                        <span id="sVal" style="margin-left:10px; font-weight:bold; color:#555">60s</span>
                    </div>
                    <div style="margin-top:30px; border-top:1px solid rgba(0,0,0,0.1); padding-top:20px; opacity:0; animation:slideInLeft 0.5s ease-out 0.4s forwards;">
                        <button class="btn btn-orange">Bind Device to Account</button>
                        <button class="btn btn-green">Save Configuration</button>
                    </div>
                </div>
            </div>

            <div id="view-account" class="page-view">
                <div class="card">
                    <h3>Account Management</h3>
                    <p class="subtext" style="margin-bottom:20px">Personalize your profile</p>
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-input" value="admin">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Change Password</label>
                        <input type="password" class="form-input" placeholder="New Password">
                    </div>
                    <div style="margin-top:30px; opacity:0; animation:slideInLeft 0.5s ease-out 0.4s forwards;">
                        <button class="btn btn-blue">Update Profile</button>
                        <button class="btn btn-red">Clear App Cache</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="event-log-screen">
        <div style="display:flex; height:100%">
            <div class="elog-sidebar">
                <div class="logo" style="margin-bottom:30px">EchoLog</div>
                <div class="elog-panel">
                    <div style="font-weight:bold; margin-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.3); padding-bottom:5px">Device-ID: Heltec Tracker</div>
                    <div class="elog-info-row" id="elog-date">Day: --.--.--</div>
                </div>
                <div style="margin-top:20px">
                    <button class="elog-btn">Change Day</button>
                    <button class="elog-btn">Save data to computer</button>
                </div>
            </div>
            <div class="elog-main">
                <div class="elog-header">
                    <div>
                        <h3>Event Log</h3>
                        <p class="subtext">View device's storage.</p>
                    </div>
                    <div>
                        <button class="btn btn-dark" onclick="closeEventLog()">< Main Menu</button>
                        <button class="btn btn-green"><i class="fas fa-download"></i> Download CSV</button>
                    </div>
                </div>
                <div class="elog-content">
                    <table class="elog-table">
                        <thead>
                            <tr><th style="width:10%">Index</th><th style="width:70%">Filename</th><th style="width:20%">Size</th></tr>
                        </thead>
                        <tbody id="elog-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    function attemptLogin() {
        const u = document.getElementById('loginUser').value;
        const p = document.getElementById('loginPass').value;
        if(u === 'admin' && p === 'admin') {
            const loginScreen = document.getElementById('login-screen');
            const app = document.getElementById('app-container');
            
            loginScreen.classList.add('login-exit');
            
            setTimeout(() => {
                loginScreen.style.display = 'none';
                app.classList.add('app-enter');
                document.getElementById('displayUsername').innerText = u;
                document.getElementById('welcomeText').innerText = "Welcome " + u;
                navTo('home');
            }, 800);
        } else {
            const err = document.getElementById('loginError');
            err.innerText = "Invalid credentials. Try admin/admin";
        }
    }

    function navTo(pageId) {
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        const navItem = document.getElementById('nav-'+pageId);
        if(navItem) navItem.classList.add('active');

        document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active-view'));
        document.getElementById('view-'+pageId).classList.add('active-view');
    }

    function openEventLog() {
        const scr = document.getElementById('event-log-screen');
        scr.style.display = 'block';
        setTimeout(() => scr.classList.add('show-log'), 10);
        
        const now = new Date();
        document.getElementById('elog-date').innerText = `Day: ${now.toLocaleDateString()}`;

        const tbody = document.getElementById('elog-table-body');
        tbody.innerHTML = '';
        for(let i=1; i<=8; i++) {
            tbody.innerHTML += `
                <tr>
                    <td>${i}</td>
                    <td>RECORDING_${20250000+i}.wav</td>
                    <td>${(Math.random()*5).toFixed(1)}MB</td>
                </tr>`;
        }
    }

    function closeEventLog() {
        const scr = document.getElementById('event-log-screen');
        scr.classList.remove('show-log');
        setTimeout(() => scr.style.display = 'none', 400);
    }

    const SERVICE_UUID = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const CHAR_CMD_UUID = "beb5483e-36e1-4688-b7f5-ea07361b26a8";
    const CHAR_DATA_UUID = "829a287c-03c4-4c22-9442-70b9687c703b";
    const CHAR_UPLOAD_UUID = "ce2e1b12-5883-4903-8120-001004b3410f";

    let device, server, service, cmdChar, dataChar, uploadChar;
    let fileBuffer = [];
    let isDownloading = false;
    let startTime;
    let isConnected = false;
    let stopUploadFlag = false;

    const connStatus = document.getElementById('connStatus');
    const bleList = document.getElementById('bleList');
    const fileSelect = document.getElementById('fileSelect');
    const dlStatus = document.getElementById('dlStatus');
    const uploadStatus = document.getElementById('uploadStatus');
    const btnScan = document.getElementById('btnScan');
    const btnDisconnect = document.getElementById('btnDisconnect');
    const btnRefresh = document.getElementById('btnRefresh');

    function formatBytes(bytes) { if(bytes===0) return '0 Bytes'; const k=1024, sizes=['Bytes','KB','MB'], i=Math.floor(Math.log(bytes)/Math.log(k)); return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+' '+sizes[i]; }
    function formatTime(seconds) { if(!isFinite(seconds)||seconds<0) return "--s"; return new Date(seconds*1000).toISOString().substr(14,5)+"s"; }

    btnScan.addEventListener('click', async () => {
        try {
            device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
            bleList.innerText = "Connecting...";
            device.addEventListener('gattserverdisconnected', onDisconnected);
            server = await device.gatt.connect();
            service = await server.getPrimaryService(SERVICE_UUID);
            cmdChar = await service.getCharacteristic(CHAR_CMD_UUID);
            dataChar = await service.getCharacteristic(CHAR_DATA_UUID);
            uploadChar = await service.getCharacteristic(CHAR_UPLOAD_UUID);
            await dataChar.startNotifications();
            dataChar.addEventListener('characteristicvaluechanged', handleIncomingData);
            onConnected();
        } catch (error) { console.error(error); bleList.innerText = "Error: " + error.message; }
    });

    function onConnected() {
        isConnected = true; connStatus.innerText = "Connected"; bleList.innerText = "Active: " + device.name; bleList.style.color = "green";
        btnScan.style.display = 'none'; btnDisconnect.style.display = 'inline-block';
        document.getElementById('btnDownload').disabled = false; document.getElementById('btnStartUpload').disabled = false; btnRefresh.disabled = false;
        refreshFileList();
    }
    function onDisconnected() {
        isConnected = false; connStatus.innerText = "Disconnected"; bleList.innerText = "Not Connected"; bleList.style.color = "#555";
        btnScan.style.display = 'inline-block'; btnDisconnect.style.display = 'none';
        btnRefresh.disabled = true; document.getElementById('btnDownload').disabled = true; document.getElementById('btnStartUpload').disabled = true;
        fileSelect.innerHTML = "<option>Disconnected</option>";
    }
    btnDisconnect.addEventListener('click', () => { if (device && device.gatt.connected) device.gatt.disconnect(); });
    btnRefresh.addEventListener('click', refreshFileList);

    function refreshFileList() { fileSelect.innerHTML = "<option>Scanning...</option>"; isDownloading = false; sendCommand("ls"); }
    async function sendCommand(cmd) { if (!isConnected) return; const enc = new TextEncoder(); await cmdChar.writeValue(enc.encode(cmd)); }

    function handleIncomingData(event) {
        const value = event.target.value;
        const decoder = new TextDecoder();
        
        if (value.byteLength < 20) { 
            const str = decoder.decode(value);
            if (str.includes("EOF")) { finishDownload(); return; }
            if (str.includes("READY")) { processUploadStream(); return; }
            if (str.includes("ERROR")) { uploadStatus.innerText = "Error: SD Error"; return; }
        }

        if (!isDownloading && value.byteLength < 100) {
            const str = decoder.decode(value);
            if (str.includes("|")) {
                const parts = str.split("|");
                const exists = Array.from(fileSelect.options).some(opt => opt.value === parts[0]);
                if(!exists) {
                    const opt = document.createElement("option");
                    opt.value = parts[0]; opt.text = `${parts[0]} (${formatBytes(parseInt(parts[1]))})`; opt.dataset.size = parts[1];
                    fileSelect.appendChild(opt);
                }
                if(fileSelect.options[0] && fileSelect.options[0].text.includes("Scanning")) fileSelect.remove(0);
                return;
            }
        }
        
        if (isDownloading) {
            const chunk = new Uint8Array(value.buffer);
            fileBuffer.push(chunk);
            downloadBytesReceived += chunk.length;
            
            if(Math.random() > 0.8) {
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                const speed = downloadBytesReceived / elapsed;
                dlStatus.innerHTML = `Downloaded: ${formatBytes(downloadBytesReceived)} / ${formatBytes(downloadTotalSize)}<br>Speed: ${formatBytes(speed)}/s`;
            }
        }
    }

    let downloadTotalSize = 0, downloadBytesReceived = 0;
    document.getElementById('btnDownload').addEventListener('click', () => {
        const filename = fileSelect.value;
        if (!filename || filename.includes("Scanning")) return;
        const selectedOpt = fileSelect.options[fileSelect.selectedIndex];
        downloadTotalSize = parseInt(selectedOpt.dataset.size || 0); downloadBytesReceived = 0;
        fileBuffer = []; isDownloading = true; startTime = Date.now(); dlStatus.innerText = "Requesting...";
        sendCommand("get " + filename);
    });
    function finishDownload() {
        if (isDownloading) {
            const blob = new Blob(fileBuffer, { type: "application/octet-stream" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileSelect.value; a.click();
            isDownloading = false; dlStatus.innerText = "Download Complete!";
        }
    }

    let uploadFileObj;
    document.getElementById('fileInput').addEventListener('change', (e) => {
        if(e.target.files.length > 0) { uploadFileObj = e.target.files[0]; uploadStatus.innerText = `File: ${uploadFileObj.name}\nSize: ${formatBytes(uploadFileObj.size)}`; }
    });
    document.getElementById('btnStartUpload').addEventListener('click', () => {
        if(!uploadFileObj) return; stopUploadFlag = false; uploadStatus.innerText = "Initializing...";
        sendCommand("upload " + uploadFileObj.name);
    });
    document.getElementById('btnStopUpload').addEventListener('click', () => { stopUploadFlag = true; uploadStatus.innerText = "Stopping..."; });

    async function processUploadStream() {
        uploadStatus.innerText = "Starting Stream...";
        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = e.target.result; const bytes = new Uint8Array(data); const total = bytes.length;
            const CHUNK_SIZE = 500; 
            let offset = 0; startTime = Date.now();

            while(offset < total) {
                if(stopUploadFlag) { uploadStatus.innerText = "Upload Cancelled"; return; }
                const end = Math.min(offset + CHUNK_SIZE, total);
                const chunk = bytes.slice(offset, end);
                
                await uploadChar.writeValue(chunk);
                
                offset += chunk.length;
                
                if (offset % (CHUNK_SIZE*5) === 0 || offset === total) {
                    const now = Date.now(); const elapsed = (now - startTime) / 1000; const speed = offset / elapsed; const pct = ((offset/total)*100).toFixed(0);
                    uploadStatus.innerHTML = `Uploading: ${pct}% (${formatBytes(offset)}/${formatBytes(total)})<br>Speed: ${formatBytes(speed)}/s`;
                }
            }
            await sendCommand("end_upload");
            uploadStatus.innerText = "Upload Complete!";
            setTimeout(refreshFileList, 1000);
        };
        reader.readAsArrayBuffer(uploadFileObj);
    }
</script>
</body>
</html>